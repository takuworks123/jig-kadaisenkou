<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="styles.css">
</head>

<body>

  <h1>メモ</h1>

  <div id="listArea"></div>


  <div id="editArea">
    <p id="nowEditingId"></p>

    
    <label>タグ</label><br>
    <select id="tag"></select>
    <input id="tagName" type="text"></input>
    
    <br><br><label>タイトル</label><br>
    <input id="title" type="text"></input>

    <br><br><label>メモ</label><br>
    <textarea id="memo" type="text" cols="30" rows="5"></textarea>

    <br>
    <button id="save">上書き保存</button>
    <button id="create">新しく保存</button>
    <button id="clear">クリア</button>
    <p id="result"></p>
  </div>
  



  <script type="module">
    let configName = 'config_tagList';
    let nowKey = -1;
    save.style.visibility = 'hidden';



    // 画面のリロード
    function reload(){
      listArea.innerHTML = '';
      tag.innerHTML = '';
      save.style.visibility = 'hidden';
      nowEditingId.textContent = '未選択';

      let newOption = document.createElement('option');
      newOption.innerText = '新規作成';
      tag.appendChild(newOption);

      let newDivList = [],
        tagAmountList = [], // 各タグの合計個数が入る
        tagList = ['%default-tag%'],
        tagStrAll;

      newDivList[newDivList.length] = document.createElement('div'); // デフォルトタグ

      // tagコンボボックスの操作
      // ローカルストレージの行数分、ループ
      for(let key in localStorage) {
        if (!localStorage.hasOwnProperty(key) || key.includes('config')) {
          continue;
        }

        let data = localStorage.getItem(key).split('%split%');
        let tagStr = data[0];

        if (tagList.includes(tagStr)){
          continue;
        }

        if (tagStrAll == undefined){
          tagStrAll = tagStr;
        }else{
          tagStrAll += '%split%' + tagStr;
        }

        tagList[tagList.length] = tagStr;

        let newOption = document.createElement('option');
        newOption.innerText = tagStr;
        tag.appendChild(newOption);

        newDivList[newDivList.length] = document.createElement('div');
      }




      let tagIndex;

      // listAreaメモ一覧の操作
      // ローカルストレージの行数分、ループ
      for(let key in localStorage) {
        if (!localStorage.hasOwnProperty(key) || key.includes('config')) {
          continue;
        }
        
        let data = localStorage.getItem(key).split('%split%');
        let tagStr = data[0],
          titleStr = data[1],
          memoStr = data[2];
        
        //let formCount = document.querySelectorAll('button').length;

        // メモの個数分ボタンを表示
        let newTitleButton = document.createElement('button');
        let newDeleteButton = document.createElement('button');
        let newBr = document.createElement('br');

        newTitleButton.id = key;
        newDeleteButton.id = key;

        newTitleButton.textContent = titleStr;
        newDeleteButton.textContent = '削除';

        newTitleButton.onclick = TitleButtonClick;
        newDeleteButton.onclick = DeleteButtonClick;
        
        newTitleButton.style.width = '80%';
        newTitleButton.style.fontSize = '16px';

        if (key == nowKey){
          save.style.visibility = 'visible';
          nowEditingId.textContent = '「' + titleStr + '」を編集中';
          newTitleButton.style.backgroundColor = 'lightblue';

          tag.selectedIndex = tagIndex = tagList.indexOf(tagStr);

          title.value = titleStr;
          memo.value = memoStr;
          
          if (tagIndex == 0){
            tagName.disabled = false;
          }else{
            tagName.disabled = true;
          }

        }else{
          newTitleButton.style.backgroundColor = "lightgray";
          tagIndex = tagList.indexOf(tagStr);
        }

        newDivList[tagIndex].appendChild(newDeleteButton);
        newDivList[tagIndex].appendChild(newTitleButton);
        newDivList[tagIndex].appendChild(newBr);
        
        if (tagAmountList[tagIndex] == undefined){
          tagAmountList[tagIndex] = 0;
        }
        tagAmountList[tagIndex]++;
      }


      for (let i = 0; i < newDivList.length; i++){
        if (tagList[tagIndex] != undefined){
          if (i != 0){
            let newBr = document.createElement('br');
            listArea.appendChild(newBr);

            let newLabel = document.createElement('p');
            newLabel.textContent = '・' + tagList[i];
            listArea.appendChild(newLabel);
          }

          listArea.appendChild(newDivList[i]);
        }
      }

      localStorage.setItem(configName, tagStrAll);

    }


    // このページを開いた時
    window.onload = async (event) => {
      reload();
    }


    // このページを閉じた時
    /*
    window.onbeforeunload = function(){
    }
    */


    // タグのコンボボックスを変更した時
    tag.onchange = function(){
      if (tag.selectedIndex == 0){
        tagName.disabled = false;
      }else{
        tagName.disabled = true;
      }

    }


    // メモ一覧のメモ選択ボタンをクリックした時
    function TitleButtonClick(){
      nowKey = this.id; // thisは押したボタンのこと

      reload();
    }


    // メモ一覧の削除ボタンを押した時
    function DeleteButtonClick(){
      localStorage.removeItem(this.id);
      
      if (nowKey == this.id){
        nowKey = -1;
      }

      reload();
      
      if (tag.selectedIndex == 0){
        tagName.disabled = false;
      }else{
        tagName.disabled = true;
      }
    }


    // 保存ボタンを押した時に
    async function Save(flag){
      let tagStr = tag[tag.selectedIndex].innerText;
      let titleStr = title.value;
      let memoStr = memo.value;

      if (titleStr.length > 100){
        alert('タイトルを100文字以内で記入してください');
      }else if (memoStr.length > 1000){
        alert('メモを1000文字以内で記入してください');
      }else if (titleStr.includes('%split%') || titleStr.includes('%split%')){
        alert('使用できない文字列がタイトル、メモのどちらかに含まれています');
      }else{

        if (flag == true){
          let max = 0;
          for(let key in localStorage) {
            key = Number(key);
            if (max < key){
              max = key;
            }
          }
          nowKey = max + 1;
          
          result.textContent = '新しく保存しました';
        }else{
          result.textContent = '上書き保存しました';
        }

        if (tag.selectedIndex == 0){ // タグを新規作成する場合
          if (tagName.value == ''){
            tagStr = '%default-tag%';

          }else{
            tagStr = tagName.value;

            let data = localStorage.getItem(configName);
            if (data == null){
              localStorage.setItem(configName, tagStr);
            }else{
              localStorage.setItem(configName, data + '%split%' + tagStr);
            }
          }
        }

        
        let value = tagStr + '%split%' + titleStr + '%split%' + memoStr;
        
        localStorage.setItem(nowKey, value);

        reload();

        setTimeout( ()=>{
          result.textContent = '';
        }, 3000 );

      }
    }


    // 上書き保存ボタンを押した時
    save.onclick = async (event) => {
      await Save(false);
    }


    // 新しく保存ボタンを押した時
    create.onclick = async (event) => {
      await Save(true);
    }


    // クリアボタンを押した時
    clear.onclick = async (event) => {
      tagName.value = '';
      title.value = '';
      memo.value = '';

      /*
      let array = ['test', 'TEST', 'tEEEE,,,,,EEEEst']

      localStorage.setItem('array', array);
      let data = localStorage.getItem('array');

      console.log(data);
      */
    }



  </script>
</body>

</html>
